<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Eco Guardian - ‡∏ú‡∏π‡πâ‡∏û‡∏¥‡∏ó‡∏±‡∏Å‡∏©‡πå‡πÅ‡∏´‡πà‡∏á‡∏û‡∏á‡πÑ‡∏û‡∏£</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Mitr:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #2c3e50;
            --ui-bg: rgba(52, 73, 94, 0.88);
            --ui-border: rgba(236, 240, 241, 0.3);
            --text-light: #ecf0f1;
            --text-dark: #bdc3c7;
            --accent-color: #f1c40f;
            --accent-hover: #f39c12;
            --water-color: #3498db;
            --xp-color: #2ecc71;
            --success-color: #27ae60;
            --error-color: #c0392b;
            --font-family: 'Mitr', sans-serif;
        }

        body, html {
            margin: 0; padding: 0;
            overflow: hidden;
            height: 100%; width: 100%;
            background-color: var(--bg-color);
            font-family: var(--font-family);
            color: var(--text-light);
            user-select: none;
            -webkit-user-select: none;
        }

        #game-container {
            position: relative;
            width: 100%; height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        canvas {
            background-color: #558b2f;
            border-radius: 12px;
            box-shadow: 0 0 30px rgba(0,0,0,0.6);
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
            image-rendering: pixelated;
            cursor: pointer;
        }

        /* --- Start Screen --- */
        #start-screen {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            background: linear-gradient(to bottom, #4a7c59, #2c5d3d);
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            z-index: 100;
            transition: opacity 1s ease-out, transform 1s ease-out;
            overflow: hidden;
        }
        .leaf { position: absolute; width: 20px; height: 20px; background-color: #81c784; border-radius: 5px 50%; opacity: 0.7; animation: fall 10s linear infinite; }
        @keyframes fall { 0% { transform: translateY(-10vh) translateX(0) rotate(0deg); } 100% { transform: translateY(110vh) translateX(10vw) rotate(360deg); } }
        #start-screen-content { animation: fadeIn 2s ease-in-out; text-align: center; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        #start-screen h1 { font-size: clamp(3rem, 10vw, 6rem); color: white; text-shadow: 4px 4px 8px rgba(0,0,0,0.4); margin: 0; }
        #start-screen p { font-size: clamp(1rem, 4vw, 1.5rem); color: var(--text-dark); text-shadow: 2px 2px 4px rgba(0,0,0,0.3); margin-top: -10px; }
        .start-menu-buttons { margin-top: 40px; display: flex; flex-direction: column; gap: 15px; }
        .start-menu-button { font-family: var(--font-family); font-size: clamp(1.5rem, 5vw, 2.5rem); padding: 15px 40px; border-radius: 50px; border: 3px solid white; background-color: var(--accent-color); color: white; cursor: pointer; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); box-shadow: 0 8px 15px rgba(0,0,0,0.2); transition: all 0.2s ease; }
        .start-menu-button:hover { transform: translateY(-4px) scale(1.05); box-shadow: 0 12px 20px rgba(0,0,0,0.3); background-color: var(--accent-hover); }
        .start-menu-button.secondary { background-color: #3498db; font-size: clamp(1rem, 4vw, 1.5rem); }
        .start-menu-button.secondary:hover { background-color: #2980b9; }


        /* --- HUD --- */
        .hud { position: absolute; padding: 10px 15px; background-color: var(--ui-bg); border: 1px solid var(--ui-border); border-radius: 12px; backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); box-shadow: 0 4px 15px rgba(0,0,0,0.2); font-size: clamp(0.9rem, 2.5vw, 1.2rem); display: flex; align-items: center; gap: 10px; }
        #hud-top-left { top: 15px; left: 15px; flex-direction: column; align-items: flex-start; gap: 8px; }
        #hud-top-right { top: 15px; right: 15px; flex-direction: row; align-items: center; gap: 15px; }
        #hud-bottom-left { bottom: 15px; left: 15px; }
        #hud-top-center { top: 15px; left: 50%; transform: translateX(-50%); width: 40%; max-width: 500px; }
        .hud-item { display: flex; align-items: center; gap: 8px; }
        .hud-icon-button { font-size: 2rem; cursor: pointer; transition: transform 0.2s; }
        .hud-icon-button:hover { transform: scale(1.2); }
        .progress-bar { width: 100px; height: 14px; background-color: rgba(0,0,0,0.3); border-radius: 7px; overflow: hidden; border: 1px solid var(--ui-border); }
        .progress-bar-inner { height: 100%; border-radius: 7px; transition: width 0.5s ease; }
        #xp-bar-inner { background: linear-gradient(90deg, #27ae60, var(--xp-color)); }
        #pollution-meter-inner { background: linear-gradient(90deg, #2ecc71 0%, #f1c40f 50%, #e74c3c 100%); }

        /* --- Toolbar --- */
        #toolbar { display: flex; gap: 8px; }
        .tool-slot { width: 55px; height: 55px; border: 2px solid var(--ui-border); border-radius: 10px; display: flex; justify-content: center; align-items: center; font-size: 28px; cursor: pointer; transition: all 0.2s ease-in-out; position: relative; background-color: rgba(0,0,0,0.2); }
        .tool-slot.selected { background-color: rgba(241, 196, 15, 0.4); border-color: var(--accent-color); transform: scale(1.15); box-shadow: 0 0 15px var(--accent-color); }
        .tool-slot .item-count { position: absolute; bottom: 2px; right: 4px; font-size: 14px; font-weight: bold; color: white; background-color: rgba(192, 57, 43,0.9); padding: 1px 5px; border-radius: 5px; }

        /* --- Modals & Dialogs --- */
        .modal { position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); background-color: var(--ui-bg); border: 2px solid var(--ui-border); border-radius: 16px; padding: 25px; z-index: 50; width: 90%; max-width: 600px; box-shadow: 0 10px 30px rgba(0,0,0,0.4); display: none; backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); animation: modal-appear 0.3s ease-out; }
        @keyframes modal-appear { from { opacity: 0; transform: translate(-50%, -45%); } to { opacity: 1; transform: translate(-50%, -50%); } }
        .modal h2 { margin-top: 0; color: var(--accent-color); text-shadow: 0 0 5px var(--accent-color); }
        .modal-button { font-family: var(--font-family); font-size: 1rem; padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; margin-top: 15px; background-color: var(--accent-color); color: #2c3e50; transition: all 0.2s; font-weight: bold; }
        .modal-button:hover { background-color: var(--accent-hover); transform: scale(1.05); }
        .modal-button:disabled { background-color: #7f8c8d; cursor: not-allowed; transform: none; }
        
        #tutorial-dialog, #villager-dialog { position: absolute; bottom: 5%; left: 50%; transform: translateX(-50%); width: 80%; max-width: 700px; z-index: 60; padding: 20px; display: none; flex-direction: row; align-items: center; gap: 20px; }
        #tutorial-portrait, #villager-portrait { font-size: 64px; animation: pop-in 0.5s; }
        #tutorial-text-container, #villager-text-container { flex-grow: 1; }
        @keyframes pop-in { from { transform: scale(0.5); } to { transform: scale(1); } }
        
        /* How to Play & Shop Modal Styles */
        .modal-content { max-height: 70vh; overflow-y: auto; padding-right: 10px; }
        .info-section { margin-bottom: 20px; }
        .info-section h3 { color: var(--accent-color); border-bottom: 1px solid var(--ui-border); padding-bottom: 5px; }
        .info-section p { line-height: 1.6; }
        .info-section .icon { font-size: 1.5em; margin-right: 10px; vertical-align: middle; }
        
        .shop-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; background-color: rgba(0,0,0,0.2); border-radius: 8px; margin-bottom: 10px; }
        .shop-item-info { display: flex; align-items: center; gap: 15px; }
        .shop-item-name { font-size: 1.2rem; }
        .shop-item-price { font-weight: bold; color: var(--accent-color); }

        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div id="game-container">
        <div id="start-screen">
            <div id="start-screen-content">
                <h1>‡∏ú‡∏π‡πâ‡∏û‡∏¥‡∏ó‡∏±‡∏Å‡∏©‡πå‡πÅ‡∏´‡πà‡∏á‡∏û‡∏á‡πÑ‡∏û‡∏£</h1>
                <p>Eco Guardian</p>
                <div class="start-menu-buttons">
                    <button id="start-button" class="start-menu-button">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°</button>
                    <button id="how-to-play-button" class="start-menu-button secondary">‡∏ß‡∏¥‡∏ò‡∏µ‡πÄ‡∏•‡πà‡∏ô</button>
                </div>
            </div>
        </div>

        <canvas id="gameCanvas"></canvas>
        
        <div id="hud-top-left" class="hud hidden">
            <div class="hud-item"><span>‡πÄ‡∏•‡πÄ‡∏ß‡∏•: <span id="player-level">1</span></span></div>
            <div class="hud-item" title="‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏Å‡∏≤‡∏£‡∏ì‡πå"><span>XP:</span><div class="progress-bar"><div id="xp-bar-inner" class="progress-bar-inner"></div></div></div>
            <div class="hud-item" title="‡πÇ‡∏Å‡∏•‡∏î‡πå">üí∞ <span id="gold-count">0</span></div>
            <div class="hud-item" title="‡∏ô‡πâ‡∏≥">üíß <span id="water-count">10</span></div>
        </div>
        <div id="hud-top-right" class="hud hidden">
            <div class="hud-item">
                <div id="season-indicator"><span id="season-icon">‚òÄÔ∏è</span> <span id="season-text">‡∏§‡∏î‡∏π‡∏£‡πâ‡∏≠‡∏ô</span></div>
                <div>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: <span id="day-count">1</span></div>
            </div>
            <div class="hud-item">
                <div id="quest-log-icon" title="‡∏™‡∏°‡∏∏‡∏î‡πÄ‡∏Ñ‡∏ß‡∏™" class="hud-icon-button">üìú</div>
                <div id="shop-icon" title="‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤" class="hud-icon-button">üõí</div>
            </div>
        </div>
        <div id="hud-top-center" class="hud hidden"><div class="hud-item" style="width: 100%; flex-direction: column;"><span>‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏°‡∏•‡∏û‡∏¥‡∏©</span><div class="progress-bar" style="width: 100%; height: 20px;"><div id="pollution-meter-inner" class="progress-bar-inner"></div></div></div></div>
        <div id="hud-bottom-left" class="hud hidden"><div id="toolbar"></div></div>

        <!-- Modals -->
        <div id="how-to-play-modal" class="modal">
            <h2>‡∏ß‡∏¥‡∏ò‡∏µ‡πÄ‡∏•‡πà‡∏ô Eco Guardian</h2>
            <div class="modal-content">
                <div class="info-section">
                    <h3><span class="icon">üéØ</span>‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</h3>
                    <p>‡∏ü‡∏∑‡πâ‡∏ô‡∏ü‡∏π‡∏õ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡πà‡∏°‡∏™‡∏•‡∏≤‡∏¢‡∏à‡∏≤‡∏Å‡∏°‡∏•‡∏û‡∏¥‡∏© "Gray Blight" ‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏•‡∏π‡∏Å‡∏ï‡πâ‡∏ô‡πÑ‡∏°‡πâ ‡∏Ñ‡∏∑‡∏ô‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡πÉ‡∏´‡πâ‡∏ú‡∏∑‡∏ô‡∏î‡∏¥‡∏ô ‡πÅ‡∏•‡∏∞‡∏õ‡∏•‡∏∏‡∏Å‡∏û‡∏•‡∏±‡∏á‡πÅ‡∏´‡πà‡∏á‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥!</p>
                </div>
                <div class="info-section">
                    <h3><span class="icon">üñ±Ô∏è</span>‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°</h3>
                    <p>‡πÉ‡∏ä‡πâ‡πÄ‡∏°‡∏≤‡∏™‡πå‡∏Ñ‡∏•‡∏¥‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏ï‡∏∞‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏î‡∏¥‡∏ô‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏à‡∏∏‡∏î‡∏´‡∏°‡∏≤‡∏¢ ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πà‡∏á‡∏ï‡πà‡∏≤‡∏á‡πÜ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏ï‡πâ‡∏ï‡∏≠‡∏ö ‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏û‡∏£‡∏ß‡∏ô‡∏î‡∏¥‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏ô‡πÑ‡∏°‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏î‡∏ô‡πâ‡∏≥</p>
                </div>
                <div class="info-section">
                    <h3><span class="icon">üõ†Ô∏è</span>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô</h3>
                    <p><span class="icon">üåæ</span><b>‡∏à‡∏≠‡∏ö:</b> ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ö‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏ç‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠ "‡∏û‡∏£‡∏ß‡∏ô‡∏î‡∏¥‡∏ô" ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏õ‡∏•‡∏π‡∏Å</p>
                    <p><span class="icon">üå±</span><b>‡πÄ‡∏°‡∏•‡πá‡∏î‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå:</b> ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ö‡∏ô "‡∏î‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏£‡∏ß‡∏ô‡πÅ‡∏•‡πâ‡∏ß" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏•‡∏π‡∏Å‡∏ï‡πâ‡∏ô‡∏≠‡πà‡∏≠‡∏ô</p>
                    <p><span class="icon">üíß</span><b>‡∏ö‡∏±‡∏ß‡∏£‡∏î‡∏ô‡πâ‡∏≥:</b> ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà "‡∏ï‡πâ‡∏ô‡∏≠‡πà‡∏≠‡∏ô" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏î‡∏ô‡πâ‡∏≥‡πÉ‡∏´‡πâ‡∏°‡∏±‡∏ô‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï</p>
                </div>
            </div>
            <button class="modal-button" onclick="document.getElementById('how-to-play-modal').style.display = 'none'">‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÅ‡∏•‡πâ‡∏ß!</button>
        </div>
        
        <div id="shop-modal" class="modal">
            <h2>üõí ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏£‡∏±‡∏™‡∏ï‡∏µ‡πâ</h2>
            <div id="shop-items-container" class="modal-content">
                <!-- Shop items will be generated here by JS -->
            </div>
            <button class="modal-button" onclick="document.getElementById('shop-modal').style.display = 'none'">‡∏õ‡∏¥‡∏î‡∏£‡πâ‡∏≤‡∏ô</button>
        </div>

        <div id="quest-log-modal" class="modal"><div class="modal-content"><h2>‡∏™‡∏°‡∏∏‡∏î‡πÄ‡∏Ñ‡∏ß‡∏™</h2><ul id="quest-list"></ul><button class="modal-button" onclick="document.getElementById('quest-log-modal').style.display = 'none'">‡∏õ‡∏¥‡∏î</button></div></div>
        <div id="message-box" class="modal" style="text-align: center;"><h2 id="message-title"></h2><p id="message-text"></p><button id="message-ok-button" class="modal-button">‡∏ï‡∏Å‡∏•‡∏á</button></div>
        <div id="tutorial-dialog" class="modal"><div id="tutorial-portrait"></div><div id="tutorial-text-container"><p id="tutorial-text"></p><button id="tutorial-continue-button" class="modal-button">‡∏ï‡πà‡∏≠‡πÑ‡∏õ</button></div></div>
        <div id="villager-dialog" class="modal"><div id="villager-portrait"></div><div id="villager-text-container"><p id="villager-text"></p><button id="villager-close-button" class="modal-button">‡∏õ‡∏¥‡∏î</button></div></div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DOM Elements ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const startScreen = document.getElementById('start-screen');
        const startButton = document.getElementById('start-button');
        const howToPlayButton = document.getElementById('how-to-play-button');
        const howToPlayModal = document.getElementById('how-to-play-modal');
        const shopIcon = document.getElementById('shop-icon');
        const shopModal = document.getElementById('shop-modal');
        const shopItemsContainer = document.getElementById('shop-items-container');
        const huds = document.querySelectorAll('.hud');
        const playerLevelUI = document.getElementById('player-level');
        const xpBarInner = document.getElementById('xp-bar-inner');
        const goldCountUI = document.getElementById('gold-count');
        const waterCountUI = document.getElementById('water-count');
        const seasonIconUI = document.getElementById('season-icon');
        const seasonTextUI = document.getElementById('season-text');
        const dayCountUI = document.getElementById('day-count');
        const pollutionMeterInner = document.getElementById('pollution-meter-inner');
        const toolbarUI = document.getElementById('toolbar');
        const questLogIcon = document.getElementById('quest-log-icon');
        const questListUI = document.getElementById('quest-list');
        const messageBox = document.getElementById('message-box');
        const messageTitle = document.getElementById('message-title');
        const messageText = document.getElementById('message-text');
        const tutorialDialog = document.getElementById('tutorial-dialog');
        const tutorialPortrait = document.getElementById('tutorial-portrait');
        const tutorialText = document.getElementById('tutorial-text');
        const tutorialContinueButton = document.getElementById('tutorial-continue-button');
        const villagerDialog = document.getElementById('villager-dialog');
        const villagerPortrait = document.getElementById('villager-portrait');
        const villagerText = document.getElementById('villager-text');
        const villagerCloseButton = document.getElementById('villager-close-button');

        // --- Game Config & State ---
        const TILE_SIZE = 48;
        let gameState = { running: false, lastTime: 0 };
        let player = {
            x: TILE_SIZE * 5, y: TILE_SIZE * 5,
            targetX: TILE_SIZE * 5, targetY: TILE_SIZE * 5,
            width: TILE_SIZE * 0.8, height: TILE_SIZE,
            speed: 220, level: 1, xp: 0, xpToNextLevel: 100,
            gold: 50, water: 20, maxWater: 50, // Start with more gold for shop testing
            inventory: [
                { id: 'hoe', name: '‡∏à‡∏≠‡∏ö', emoji: '‚Äçüåæ', type: 'tool', selected: true },
                { id: 'watering_can', name: '‡∏ö‡∏±‡∏ß‡∏£‡∏î‡∏ô‡πâ‡∏≥', emoji: 'üíß', type: 'tool' },
                { id: 'basic_seed', name: '‡πÄ‡∏°‡∏•‡πá‡∏î‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô', emoji: 'üå±', type: 'seed', quantity: 5 },
                { id: 'axe', name: '‡∏Ç‡∏ß‡∏≤‡∏ô', emoji: 'ü™ì', type: 'tool' },
            ],
            selectedItemIndex: 0,
        };
        let world = { map: [], objects: [], npcs: [], particles: [], width: TILE_SIZE * 25, height: TILE_SIZE * 15, pollution: 0.5 };
        let time = { day: 1, season: 'summer', dayLength: 120, timeOfDay: 0, dayTimer: 0 };
        const SEASONS = {
            summer: { name: '‡∏§‡∏î‡∏π‡∏£‡πâ‡∏≠‡∏ô', icon: '‚òÄÔ∏è', color: '#ffecb3' },
            autumn: { name: '‡∏§‡∏î‡∏π‡πÉ‡∏ö‡πÑ‡∏°‡πâ‡∏£‡πà‡∏ß‡∏á', icon: 'üçÇ', color: '#ffcc80' },
            winter: { name: '‡∏§‡∏î‡∏π‡∏´‡∏ô‡∏≤‡∏ß', icon: '‚ùÑÔ∏è', color: '#e0f7fa' },
            spring: { name: '‡∏§‡∏î‡∏π‡πÉ‡∏ö‡πÑ‡∏°‡πâ‡∏ú‡∏•‡∏¥', icon: 'üå∏', color: '#c8e6c9' },
        };
        let quests = [];
        
        // --- Tutorial & Dialogue ---
        let tutorialState = { isActive: false, step: 0, triggerMet: false };
        const tutorialSteps = [
            { speaker: 'üå≥', text: '‡πÄ‡∏Æ‡πâ! ‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏Å‡πá‡∏°‡∏µ‡∏Ñ‡∏ô‡∏°‡∏≤! ‡∏ô‡∏∂‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠‡∏≠‡∏µ‡∏Å‡∏£‡πâ‡∏≠‡∏¢‡∏õ‡∏µ‡∏ã‡∏∞‡πÅ‡∏•‡πâ‡∏ß ‡∏õ‡πà‡∏≤‡πÅ‡∏ñ‡∏ß‡∏ô‡∏µ‡πâ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏¢‡πà‡∏™‡∏∏‡∏î‡πÜ ‡πÄ‡∏•‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô' },
            { speaker: 'üå≥', text: '‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡∏≠‡∏≤‡∏ß‡∏∏‡πÇ‡∏™‡∏´‡∏ô‡πà‡∏≠‡πÑ‡∏°‡πâ... ‡πÅ‡∏ï‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏û‡∏µ‡πà‡πÑ‡∏°‡πâ‡πÄ‡∏â‡∏¢‡πÜ ‡∏Å‡πá‡πÑ‡∏î‡πâ ‡∏û‡∏ß‡∏Å‡∏°‡∏•‡∏û‡∏¥‡∏© "Gray Blight" ‡∏°‡∏±‡∏ô‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏•‡∏∑‡∏ô‡∏Å‡∏¥‡∏ô‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á' },
            { speaker: 'üå≥', text: '‡πÄ‡∏≠‡∏≤‡∏•‡πà‡∏∞ ‡∏°‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏±‡∏ô‡πÄ‡∏•‡∏¢! ‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡πÄ‡∏°‡∏≤‡∏™‡πå‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏û‡∏∑‡πâ‡∏ô‡∏ï‡∏£‡∏á‡πÑ‡∏´‡∏ô‡∏Å‡πá‡πÑ‡∏î‡πâ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏î‡∏¥‡∏ô‡πÑ‡∏õ‡∏à‡∏∏‡∏î‡∏ô‡∏±‡πâ‡∏ô‡∏î‡∏π‡∏î‡∏¥‡πä', trigger: { type: 'move' } },
            { speaker: 'üå≥', text: '‡πÄ‡∏à‡πã‡∏á! ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏ú‡πà‡∏≤‡∏ô! ‡∏ï‡πà‡∏≠‡πÑ‡∏õ...‡πÄ‡∏´‡πá‡∏ô‡πÅ‡∏ñ‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏Ç‡πâ‡∏≤‡∏á‡∏•‡πà‡∏≤‡∏á‡∏ô‡∏±‡πà‡∏ô‡∏°‡∏±‡πâ‡∏¢? ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡∏à‡∏≠‡∏ö" (üåæ) ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏ç‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏û‡∏£‡∏ß‡∏ô‡∏î‡∏¥‡∏ô‡πÄ‡∏•‡∏¢!', trigger: { type: 'till' } },
            { speaker: 'üå≥', text: '‡∏™‡∏ß‡∏¢‡∏û‡∏µ‡πà‡∏™‡∏ß‡∏¢! ‡∏î‡∏¥‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏õ‡∏•‡∏π‡∏Å‡∏•‡∏∞! ‡∏ó‡∏µ‡∏ô‡∏µ‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡πÄ‡∏°‡∏•‡πá‡∏î‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå" (üå±) ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏•‡∏¥‡∏Å‡∏•‡∏á‡∏ö‡∏ô‡∏î‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏£‡∏ß‡∏ô‡πÑ‡∏ß‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏µ‡πâ‡πÄ‡∏•‡∏¢', trigger: { type: 'plant' } },
            { speaker: 'üå≥', text: '‡∏ï‡πâ‡∏ô‡∏≠‡πà‡∏≠‡∏ô‡∏°‡∏±‡∏ô‡∏´‡∏¥‡∏ß‡∏ô‡πâ‡∏≥‡∏ô‡∏∞! ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡∏ö‡∏±‡∏ß‡∏£‡∏î‡∏ô‡πâ‡∏≥" (üíß) ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏•‡∏¥‡∏Å‡∏£‡∏î‡∏ô‡πâ‡∏≥‡πÉ‡∏´‡πâ‡∏°‡∏±‡∏ô‡∏´‡∏ô‡πà‡∏≠‡∏¢‡πÄ‡∏£‡πá‡∏ß!', trigger: { type: 'water' } },
            { speaker: 'üå≥', text: '‡πÅ‡∏à‡πà‡∏°! ‡πÅ‡∏Ñ‡πà‡∏ô‡∏µ‡πâ‡πÅ‡∏´‡∏•‡∏∞‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô ‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏Å‡πá‡∏•‡∏∏‡∏¢‡πÄ‡∏•‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô! ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏õ‡πà‡∏≤‡∏ô‡∏µ‡πâ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÄ‡∏ü‡∏µ‡πâ‡∏¢‡∏ß‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ô‡∏∞!' },
        ];
        const villagerDialogues = ["‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏î‡∏µ‡∏à‡∏±‡∏á‡πÄ‡∏ô‡∏≠‡∏∞", "‡πÄ‡∏´‡πá‡∏ô‡∏ï‡πâ‡∏ô‡πÑ‡∏°‡πâ‡∏ó‡∏µ‡πà‡∏ô‡∏≤‡∏¢‡∏õ‡∏•‡∏π‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡∏ä‡∏∑‡πà‡∏ô‡πÉ‡∏à‡∏à‡∏£‡∏¥‡∏á‡πÜ", "‡∏™‡∏π‡πâ‡πÜ‡∏ô‡∏∞ ‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡∏π!", "‡∏ö‡∏≤‡∏á‡∏ó‡∏µ‡∏Å‡πá‡∏≠‡∏¢‡∏≤‡∏Å‡∏Å‡∏¥‡∏ô‡∏´‡∏°‡∏π‡∏Å‡∏£‡∏∞‡∏ó‡∏∞...", "‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏°‡∏•‡∏û‡∏¥‡∏©‡∏î‡πâ‡∏ß‡∏¢‡∏•‡πà‡∏∞"];

        // --- Shop Data ---
        const shopItems = [
            { id: 'buy_seeds', name: '‡πÄ‡∏°‡∏•‡πá‡∏î‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô 5 ‡πÄ‡∏°‡∏•‡πá‡∏î', emoji: 'üå±', price: 25, action: () => {
                const seedItem = player.inventory.find(item => item.id === 'basic_seed');
                if (seedItem) seedItem.quantity += 5;
                else player.inventory.push({ id: 'basic_seed', name: '‡πÄ‡∏°‡∏•‡πá‡∏î‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô', emoji: 'üå±', type: 'seed', quantity: 5 });
            }},
            { id: 'buy_fertilizer', name: '‡∏õ‡∏∏‡πã‡∏¢‡πÄ‡∏£‡πà‡∏á‡πÇ‡∏ï', emoji: 'üí©', price: 40, action: () => {
                 const fertilizer = player.inventory.find(item => item.id === 'fertilizer');
                if (fertilizer) fertilizer.quantity += 1;
                else player.inventory.push({ id: 'fertilizer', name: '‡∏õ‡∏∏‡πã‡∏¢‡πÄ‡∏£‡πà‡∏á‡πÇ‡∏ï', emoji: 'üí©', type: 'special', quantity: 1 });
            }},
            { id: 'refill_water', name: '‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡πâ‡∏≥‡πÄ‡∏ï‡πá‡∏°‡∏ñ‡∏±‡∏á', emoji: 'üíß', price: 10, action: () => {
                player.water = player.maxWater;
            }}
        ];

        // --- UI Update Functions ---
        function updateHUD() {
            playerLevelUI.textContent = player.level;
            xpBarInner.style.width = `${(player.xp / player.xpToNextLevel) * 100}%`;
            goldCountUI.textContent = player.gold;
            waterCountUI.textContent = `${player.water}/${player.maxWater}`;
            const seasonInfo = SEASONS[time.season];
            seasonIconUI.textContent = seasonInfo.icon;
            seasonTextUI.textContent = seasonInfo.name;
            dayCountUI.textContent = time.day;
            pollutionMeterInner.style.width = `${world.pollution * 100}%`;
        }

        function updateToolbar() {
            toolbarUI.innerHTML = '';
            player.inventory.forEach((item, index) => {
                const slot = document.createElement('div');
                slot.className = 'tool-slot';
                slot.title = item.name;
                slot.innerHTML = item.emoji;
                if (item.quantity) {
                    const count = document.createElement('span');
                    count.className = 'item-count';
                    count.textContent = item.quantity;
                    slot.appendChild(count);
                }
                if (index === player.selectedItemIndex) slot.classList.add('selected');
                slot.addEventListener('click', (e) => { e.stopPropagation(); player.selectedItemIndex = index; updateToolbar(); });
                toolbarUI.appendChild(slot);
            });
        }
        
        function updateShopUI() {
            shopItemsContainer.innerHTML = '';
            shopItems.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'shop-item';
                itemDiv.innerHTML = `
                    <div class="shop-item-info">
                        <span class="icon">${item.emoji}</span>
                        <span class="shop-item-name">${item.name}</span>
                    </div>
                    <button class="modal-button shop-buy-button" data-item-id="${item.id}">
                        <span class="shop-item-price">üí∞ ${item.price}</span>
                    </button>
                `;
                shopItemsContainer.appendChild(itemDiv);
            });
            
            // Add event listeners to new buttons
            document.querySelectorAll('.shop-buy-button').forEach(button => {
                button.addEventListener('click', () => {
                    const itemId = button.dataset.itemId;
                    const itemToBuy = shopItems.find(i => i.id === itemId);
                    if (itemToBuy && player.gold >= itemToBuy.price) {
                        player.gold -= itemToBuy.price;
                        itemToBuy.action();
                        updateHUD();
                        updateToolbar();
                        // Optional: visual feedback for purchase
                        button.style.backgroundColor = '#27ae60'; // FIX: Use hex code directly
                        button.textContent = '‡∏ã‡∏∑‡πâ‡∏≠‡πÅ‡∏•‡πâ‡∏ß!';
                        setTimeout(() => {
                           button.style.backgroundColor = '';
                           button.innerHTML = `<span class="shop-item-price">üí∞ ${itemToBuy.price}</span>`;
                        }, 1000);
                    } else {
                         // Optional: visual feedback for failure
                        button.style.backgroundColor = '#c0392b'; // FIX: Use hex code directly
                        setTimeout(() => { button.style.backgroundColor = ''; }, 1000);
                    }
                });
            });
        }

        // --- Initialization ---
        function init() {
            canvas.width = world.width;
            canvas.height = world.height;
            generateMap();
            updateToolbar();
            updateHUD();
            
            startScreen.style.opacity = '0';
            startScreen.style.transform = 'scale(1.2)';
            setTimeout(() => {
                startScreen.classList.add('hidden');
                huds.forEach(hud => hud.classList.remove('hidden'));
                startTutorial();
            }, 1000);

            gameState.running = true;
            gameState.lastTime = performance.now();
            requestAnimationFrame(gameLoop);
        }
        
        function generateMap() {
             world.map = [];
            for (let y = 0; y < Math.ceil(world.height / TILE_SIZE); y++) {
                const row = [];
                for (let x = 0; x < Math.ceil(world.width / TILE_SIZE); x++) {
                    row.push({ type: Math.random() < world.pollution ? 'blight' : 'grass' });
                }
                world.map.push(row);
            }
            world.npcs.push({ id: 'elder_bamboo', type: 'elder', name: '‡∏ú‡∏π‡πâ‡∏≠‡∏≤‡∏ß‡∏∏‡πÇ‡∏™‡∏´‡∏ô‡πà‡∏≠‡πÑ‡∏°‡πâ', x: TILE_SIZE * 20, y: TILE_SIZE * 3 });
            for (let i = 0; i < 3; i++) {
                world.npcs.push({
                    id: `villager_${i}`, type: 'villager', name: '‡∏ä‡∏≤‡∏ß‡∏ö‡πâ‡∏≤‡∏ô',
                    x: TILE_SIZE * (10 + i * 2), y: TILE_SIZE * (10 + i),
                    width: TILE_SIZE * 0.8, height: TILE_SIZE,
                    speed: 60,
                    moveTimer: Math.random() * 5, targetX: null, targetY: null,
                    color: `hsl(${Math.random() * 360}, 60%, 70%)`
                });
            }
        }
        
        function createLeaves() {
            for(let i=0; i<15; i++) {
                const leaf = document.createElement('div');
                leaf.className = 'leaf';
                leaf.style.left = `${Math.random() * 100}vw`;
                leaf.style.animationDuration = `${5 + Math.random() * 5}s`;
                leaf.style.animationDelay = `${Math.random() * 5}s`;
                document.getElementById('start-screen').appendChild(leaf);
            }
        }
        createLeaves();

        // --- Game Loop ---
        function gameLoop(currentTime) {
            if (!gameState.running) return;
            const deltaTime = (currentTime - gameState.lastTime) / 1000;
            gameState.lastTime = currentTime;
            update(deltaTime);
            draw();
            requestAnimationFrame(gameLoop);
        }

        function update(deltaTime) {
            updateTime(deltaTime);
            updatePlayer(deltaTime);
            updateNPCs(deltaTime);
            updateParticles(deltaTime);
            updateWorldObjects(deltaTime);
            checkTutorialProgress();
        }
        
        function updatePlayer(deltaTime) {
            const vecX = player.targetX - player.x;
            const vecY = player.targetY - player.y;
            const dist = Math.sqrt(vecX * vecX + vecY * vecY);

            if (dist > 5) {
                player.x += (vecX / dist) * player.speed * deltaTime;
                player.y += (vecY / dist) * player.speed * deltaTime;
            }
        }

        function updateNPCs(deltaTime) {
             world.npcs.forEach(npc => {
                if (npc.type !== 'villager') return;
                npc.moveTimer -= deltaTime;
                if (npc.moveTimer <= 0) {
                    if (npc.targetX === null) {
                        npc.targetX = Math.random() * world.width;
                        npc.targetY = Math.random() * world.height;
                        npc.moveTimer = 3 + Math.random() * 4;
                    } else {
                        npc.targetX = null; npc.targetY = null;
                        npc.moveTimer = 2 + Math.random() * 3;
                    }
                }
                if (npc.targetX !== null) {
                    const vecX = npc.targetX - npc.x;
                    const vecY = npc.targetY - npc.y;
                    const dist = Math.sqrt(vecX*vecX + vecY*vecY);
                    if (dist < 10) {
                        npc.targetX = null; npc.targetY = null;
                    } else {
                        npc.x += (vecX / dist) * npc.speed * deltaTime;
                        npc.y += (vecY / dist) * npc.speed * deltaTime;
                    }
                }
            });
        }
        
        function updateWorldObjects(deltaTime) {
            world.objects.forEach(obj => {
                if (obj.type === 'tree' && obj.growth < 1) {
                    let growthRate = 1 / obj.growthTime;
                    if (obj.isFertilized) growthRate *= 2; // Double growth speed if fertilized
                    obj.growth += growthRate * deltaTime;
                    if(obj.growth >= 1) {
                        obj.growth = 1;
                        obj.isFertilized = false; // Fertilizer wears off
                    }
                }
            });
        }

        function updateParticles(deltaTime) {
            for (let i = world.particles.length - 1; i >= 0; i--) {
                const p = world.particles[i];
                 if (p.update) { p.update(deltaTime); } 
                 else { p.x += p.vx * deltaTime; p.y += p.vy * deltaTime; p.vy += p.gravity; }
                p.lifespan -= deltaTime;
                if (p.lifespan <= 0) world.particles.splice(i, 1);
            }
        }
        
        function updateTime(deltaTime) {
            time.dayTimer += deltaTime;
            if (time.dayTimer >= time.dayLength) {
                time.dayTimer = 0;
                time.day++;
                updateHUD();
            }
        }

        // --- Drawing Logic ---
        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = SEASONS[time.season].color;
            ctx.fillRect(0,0,canvas.width, canvas.height);
            drawMap();
            drawClickMarker();
            drawWorldObjects();
            drawNPCs();
            drawPlayer();
            drawParticles();
        }
        
        function drawMap() {
             for (let y = 0; y < world.map.length; y++) {
                for (let x = 0; x < world.map[y].length; x++) {
                    const tile = world.map[y][x];
                    if (tile.type === 'grass') ctx.fillStyle = '#689f38';
                    else if (tile.type === 'blight') ctx.fillStyle = '#6d4c41';
                    else if (tile.type === 'tilled' || tile.type === 'planted_soil') ctx.fillStyle = '#8d6e63';
                    ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
                }
            }
        }
        
        function drawWorldObjects() {
            world.objects.forEach(obj => {
                if(obj.type === 'tree') {
                    const growthScale = 0.4 + (obj.growth * 0.6);
                    const treeX = obj.x + TILE_SIZE / 2;
                    const treeY = obj.y + TILE_SIZE / 2;
                    if (obj.isFertilized) { // Visual feedback for fertilizer
                        ctx.fillStyle = 'rgba(255, 255, 100, 0.5)';
                        ctx.beginPath();
                        ctx.arc(treeX, treeY, TILE_SIZE * 0.6, 0, Math.PI * 2);
                        ctx.fill();
                    }
                    ctx.fillStyle = '#5d4037';
                    ctx.fillRect(treeX - 4, treeY - 5, 8, 10);
                    ctx.fillStyle = obj.waterLevel > 0 ? '#4caf50' : '#cddc39';
                    ctx.beginPath();
                    ctx.arc(treeX, treeY - 15, TILE_SIZE * 0.4 * growthScale, 0, Math.PI * 2);
                    ctx.fill();
                }
            });
        }
        
        function drawPlayer() {
            const p = player;
            ctx.save();
            ctx.translate(p.x, p.y);
            ctx.fillStyle = "#4a4a4a";
            ctx.fillRect(-p.width * 0.15, 0, p.width * 0.3, p.height * 0.4);
            ctx.fillRect(p.width * 0.15, 0, p.width * 0.3, p.height * 0.4);
            ctx.fillStyle = "#e74c3c";
            ctx.fillRect(-p.width * 0.4, -p.height * 0.5, p.width * 0.8, p.height * 0.5);
            ctx.fillStyle = "#f1c40f";
            ctx.beginPath();
            ctx.arc(0, -p.height * 0.6, p.width * 0.4, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = "#ffdab9";
            ctx.beginPath();
            ctx.arc(0, -p.height * 0.55, p.width * 0.3, 0, Math.PI * 2);
            ctx.fill();
            ctx.restore();
        }

        function drawNPCs() {
             world.npcs.forEach(npc => {
                if (npc.type === 'elder') {
                    ctx.fillStyle = '#8d6e63';
                    ctx.fillRect(npc.x, npc.y + TILE_SIZE * 0.5, TILE_SIZE, TILE_SIZE * 0.5);
                    ctx.fillStyle = '#a1887f';
                    ctx.beginPath();
                    ctx.ellipse(npc.x + TILE_SIZE/2, npc.y + TILE_SIZE * 0.5, TILE_SIZE/2, TILE_SIZE/5, 0, 0, Math.PI * 2);
                    ctx.fill();
                } else if (npc.type === 'villager') {
                    ctx.fillStyle = npc.color;
                    ctx.fillRect(npc.x - npc.width/2, npc.y - npc.height, npc.width, npc.height*0.6);
                    ctx.fillStyle = '#ffcc80';
                    ctx.beginPath();
                    ctx.arc(npc.x, npc.y - npc.height*0.6, npc.width/2.5, 0, Math.PI*2);
                    ctx.fill();
                }
            });
        }
        
        function drawParticles() {
            world.particles.forEach(p => {
                if (p.type === 'ripple') return;
                ctx.fillStyle = p.color;
                ctx.globalAlpha = Math.max(0, p.lifespan / p.initialLife);
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                ctx.fill();
                ctx.globalAlpha = 1;
            });
        }

        function drawClickMarker() {
            const ripple = world.particles.find(p => p.type === 'ripple');
            if (ripple) {
                ctx.strokeStyle = `rgba(255, 255, 255, ${Math.max(0, ripple.lifespan / ripple.initialLife)})`;
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.arc(ripple.x, ripple.y, ripple.size, 0, Math.PI * 2);
                ctx.stroke();
            }
        }
        
        function createParticles(x, y, count, options) {
            for (let i = 0; i < count; i++) {
                const angle = Math.random() * Math.PI * 2;
                const speed = Math.random() * (options.maxSpeed || 80) + (options.minSpeed || 20);
                world.particles.push({
                    x, y,
                    vx: Math.cos(angle) * speed,
                    vy: Math.sin(angle) * speed,
                    lifespan: Math.random() * (options.maxLife || 0.8) + (options.minLife || 0.3),
                    initialLife: options.maxLife || 0.8,
                    color: options.color || 'white',
                    size: Math.random() * (options.maxSize || 4) + (options.minSize || 2),
                    gravity: options.gravity || 1.5,
                });
            }
        }
        
        function createRipple(x, y) {
            world.particles = world.particles.filter(p => p.type !== 'ripple');
            world.particles.push({
                type: 'ripple', x, y,
                lifespan: 0.5, initialLife: 0.5,
                size: 0,
                update: function(deltaTime) { this.lifespan -= deltaTime; this.size += 80 * deltaTime; }
            });
        }

        // --- Tutorial & Dialogue Logic ---
        function startTutorial() { tutorialState.isActive = true; tutorialState.step = 0; showTutorialStep(); }
        function showTutorialStep() { if (tutorialState.step >= tutorialSteps.length) { endTutorial(); return; } const currentStep = tutorialSteps[tutorialState.step]; tutorialPortrait.textContent = currentStep.speaker; tutorialText.textContent = currentStep.text; tutorialDialog.style.display = 'flex'; const hasTrigger = !!currentStep.trigger; tutorialContinueButton.classList.toggle('hidden', hasTrigger); if (hasTrigger) tutorialState.triggerMet = false; }
        function advanceTutorial() { tutorialState.step++; showTutorialStep(); }
        function checkTutorialProgress() { if (!tutorialState.isActive) return; const currentStep = tutorialSteps[tutorialState.step]; if (currentStep.trigger && tutorialState.triggerMet) { advanceTutorial(); } }
        function endTutorial() { tutorialState.isActive = false; tutorialDialog.style.display = 'none'; }
        
        // --- Player Actions ---
        function handleCanvasClick(e) {
            const rect = canvas.getBoundingClientRect();
            const clickX = e.clientX - rect.left;
            const clickY = e.clientY - rect.top;

            if (tutorialState.isActive && !tutorialSteps[tutorialState.step].trigger) return;

            for (const npc of world.npcs) {
                const dist = Math.hypot(clickX - npc.x, clickY - (npc.y - npc.height/2));
                if (dist < TILE_SIZE * 0.8) {
                    if (npc.type === 'villager') {
                        villagerPortrait.textContent = 'üßë‚Äçüåæ';
                        villagerText.textContent = villagerDialogues[Math.floor(Math.random() * villagerDialogues.length)];
                        villagerDialog.style.display = 'flex';
                        return;
                    }
                }
            }

            const tileX = Math.floor(clickX / TILE_SIZE);
            const tileY = Math.floor(clickY / TILE_SIZE);
            const objectOnTile = world.objects.find(obj => Math.floor(obj.x/TILE_SIZE) === tileX && Math.floor(obj.y/TILE_SIZE) === tileY);
            const selectedItem = player.inventory[player.selectedItemIndex];

            if (objectOnTile && objectOnTile.type === 'tree') {
                if (selectedItem.id === 'watering_can') {
                    if (player.water > 0) { 
                        objectOnTile.waterLevel = 1; player.water--; updateHUD(); 
                        createParticles(clickX, clickY, 15, { color: 'rgba(52, 152, 219, 0.7)', minSize: 3, maxSize: 6, gravity: 2 });
                        if (tutorialState.isActive && tutorialSteps[tutorialState.step]?.trigger?.type === 'water') tutorialState.triggerMet = true;
                    } 
                } else if (selectedItem.id === 'fertilizer' && !objectOnTile.isFertilized) {
                    objectOnTile.isFertilized = true;
                    selectedItem.quantity--;
                    if(selectedItem.quantity <= 0) player.inventory.splice(player.selectedItemIndex, 1);
                    updateToolbar();
                }
                return;
            }
            
            const groundTile = world.map[tileY]?.[tileX];
            if (groundTile) {
                 if (selectedItem.id === 'hoe' && groundTile.type === 'grass') {
                    groundTile.type = 'tilled';
                    createParticles(clickX, clickY, 20, { color: '#8d6e63', minLife: 0.5, maxLife: 1.2, gravity: 3 });
                    if (tutorialState.isActive && tutorialSteps[tutorialState.step]?.trigger?.type === 'till') tutorialState.triggerMet = true;
                    return;
                }
                if (selectedItem.id === 'basic_seed' && groundTile.type === 'tilled') {
                    world.objects.push({ type: 'tree', x: tileX * TILE_SIZE, y: tileY * TILE_SIZE, growth: 0, growthTime: 30, waterLevel: 1, isFertilized: false });
                    groundTile.type = 'planted_soil'; selectedItem.quantity--; updateToolbar();
                    createParticles(clickX, clickY, 15, { color: 'rgba(46, 204, 113, 0.8)', minSize: 3, maxSize: 6, gravity: -1 });
                    if (tutorialState.isActive && tutorialSteps[tutorialState.step]?.trigger?.type === 'plant') tutorialState.triggerMet = true;
                    return;
                }
            }
            
            player.targetX = clickX;
            player.targetY = clickY;
            createRipple(clickX, clickY);
            if (tutorialState.isActive && tutorialSteps[tutorialState.step]?.trigger?.type === 'move') {
                tutorialState.triggerMet = true;
            }
        }
        
        // --- Event Listeners ---
        startButton.addEventListener('click', init);
        howToPlayButton.addEventListener('click', () => { howToPlayModal.style.display = 'block'; });
        shopIcon.addEventListener('click', () => { updateShopUI(); shopModal.style.display = 'block'; });
        canvas.addEventListener('click', handleCanvasClick);
        questLogIcon.addEventListener('click', () => { document.getElementById('quest-log-modal').style.display = 'block'; });
        tutorialContinueButton.addEventListener('click', advanceTutorial);
        villagerCloseButton.addEventListener('click', () => villagerDialog.style.display = 'none');
    });
    </script>
</body>
</html>
